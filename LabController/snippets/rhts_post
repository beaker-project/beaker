$yum_config_stanza
# End yum configuration
$SNIPPET('post_install_kernel_options')
$SNIPPET('func_register_if_enabled')
$SNIPPET('download_config_files')
$SNIPPET('koan_environment')
$SNIPPET('redhat_register')
# Enable post-install boot notification
$SNIPPET('post_anamon')

## Turn on ntpd
/sbin/chkconfig ntpdate on
/sbin/chkconfig ntpd on
echo 'OPTIONS="\$OPTIONS -x"' >>/etc/sysconfig/ntpd

#if $getVar('grubport','') != ''
#/bin/sed -i 's/^serial.*/serial --port=$grubport --speed=115200/' /boot/grub/grub.conf
/bin/sed -i 's/^\(serial.*\)--unit=\S\+\(.*\)\$/\1--port=$grubport\2/' /boot/grub/grub.conf
#end if

#if $getVar('arch','') == 'ia64'
BOOT=\$(/usr/sbin/efibootmgr -v | grep BootOrder | awk '{print \$2}' | awk -F, '{print \$1}')
EFI=\$(/usr/sbin/efibootmgr -v | grep Boot\$BOOT | awk '{print \$NF}')
PXE_SLOT=\$(/usr/sbin/efibootmgr -v | grep -i Netboot |cut -c5-8)
#
# If There is no Netboot Entry we can't continue
# You have to manually setup a Netboot entry first
# from EFI maint menu.
#
if [ ! -z \$PXE_SLOT ]; then
   NEWBOOT=\$(echo \$BOOT| sed -e 's/\$PXE_SLOT,//')
   # its cheesy. but it works.
   NEWBOOT=\$(echo \$NEWBOOT| sed -e 's/,\$PXE_SLOT,//')
   NEWBOOT=\$(echo \$NEWBOOT| sed -e 's/,\$PXE_SLOT//')
   /usr/sbin/efibootmgr -o \$PXE_SLOT,\$NEWBOOT
   /usr/sbin/efibootmgr -n \$BOOT
fi
#end if

#set $yum = $getVar("yum","")
#if $yum == ""
    #if $os_version == "rhel3"
        #set $yum = "yum-2.2.2-1.rhts.EL3.noarch.rpm"
    #end if
    #if $os_version == "rhel4"
        #set $yum = "yum-2.2.2-1.rhts.EL4.noarch.rpm"
    #end if
#end if

#if $yum != ""
# Install Yum
pushd /root
/usr/bin/wget -N http://$server/beaker/$yum
/bin/rpm -Uvh $yum
popd
#end if

# Add Distro Repos
#if $getVar('tree_repos','') != ''
#set $i = 0
#for $repo in $getVar('tree_repos','').split(':')
#set $i = $i + 1
#if $repo.find(",") != -1
#set (reponame, repourl) = $repo.split(',',1)
#else
#set $reponame = "beaker-distro%s" % i
#set $repourl = $repo
#end if
cat << EOF > /etc/yum.repos.d/${reponame}.repo
[$reponame]
name=$reponame
baseurl=http://$server/distros$repourl
enabled=1
gpgcheck=0
EOF
#end for
#end if

# Add Harness Repos
#if $getVar('harnessrepos','') != ''
#for $repo in $getVar('harnessrepos','').split('|')
#set (reponame, repourl) = $repo.split(',', 1)
cat << EOF >/etc/yum.repos.d/${reponame}.repo
[$reponame]
name=$reponame
baseurl=$repourl
enabled=1
gpgcheck=0
EOF
#end for
#end if

# Add Custom Repos
#if $getVar('customrepos','') != ''
#set $i = 0
#for $repo in $getVar('customrepos','').split('|')
#set $i = $i + 1
#if $repo.find(",") != -1
#set (reponame, repourl) = $repo.split(',', 1)
#else
#set $reponame = "customrepo%s" % i
#set $repourl = $repo
#end if
cat << EOF >/etc/yum.repos.d/${reponame}.repo
[$reponame]
name=$reponame
baseurl=$repourl
enabled=1
gpgcheck=0
EOF
#end for
#end if

#if $getVar('rhts_server','') != ''
# Add RHTS Test Repo
cat << EOF > /etc/yum.repos.d/rhts-tests.repo
[rhts-noarch]
name=rhts tests $testrepo
baseurl=http://$rhts_server/rpms/$testrepo/noarch/noarch
enabled=1
gpgcheck=0
EOF

# Install RHTS RPMS
yum -y --disablerepo=* --enablerepo=rhts-noarch \
                       --enablerepo=distro* \
                       --enablerepo=customrepo* install rhts-test-env-lab rhts-legacy
yum -y --disablerepo=* --enablerepo=rhts-noarch \
                       --enablerepo=distro* \
                       --enablerepo=customrepo*  install yum-utils

# Get the RHTS job
#if $getVar('runtest_url','') != ''
wget -O /mnt/tests/runtests.sh http://$rhts_server/testlogs/$runtest_url
#else
wget -O /mnt/tests/runtests.sh http://$rhts_server/testlogs/recipes/$recipeid/runtests.sh
#end if
chmod 755 /mnt/tests/runtests.sh
#end if

# Install old rhts commands
yum -y --disablerepo=* --enablerepo=beaker-* install rhts-test-env-lab rhts-legacy
## If koan is available install it.  This allows for easy re-installs
yum -y --disablerepo=* --enablerepo=beaker-* install koan
# Install new harness
yum -y --disablerepo=* --enablerepo=beaker-* install beah
# This may fail if you are outside of Red Hat..
yum -y --disablerepo=* --enablerepo=beaker-* install beaker-lib-redhat
cat << EOF > /etc/beah_beaker.conf
[DEFAULT]
# LAB_CONTROLLER: URI of Beaker's XML-RPC handler
LAB_CONTROLLER=http://$server:8000/server
#
# # HOSTNAME: Pretend to be machine with given name:
# #HOSTNAME=fake.hostname.com
HOSTNAME=$name
EOF
# Turn on Debug logging
/bin/sed -i 's/DEVEL=False/DEVEL=True/' /etc/beah.conf
/bin/sed -i 's/INTERFACE=localhost/INTERFACE=/' /etc/beah.conf
/bin/sed -i 's/CONSOLE_LOG=.*/CONSOLE_LOG=True/' /etc/beah.conf

chkconfig --add beah-srv
chkconfig --add beah-beaker-backend
chkconfig --add beah-fwd-backend

#Add test user account
useradd --password '\$6\$oIW3o2Mr\$XbWZKaM7nA.cQqudfDJScupXOia5h1u517t6Htx/Q/MgXm82Pc/OcytatTeI4ULNWOMJzvpCigWiL4xKP9PX4.' test
$SNIPPET('post_koan')
$kickstart_done
$SNIPPET('post_s390_reboot')
